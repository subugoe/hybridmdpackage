---
title: "Metacheck input"
output: 
  flexdashboard::flex_dashboard:
    css: !expr subugoetheme::pkgdown_template()$assets$css
runtime: shiny
---

```{r global, include=FALSE}
library(shiny)
library(metacheck)
```


```{r}
shinyjs::useShinyjs(rmd = TRUE)
biblids::doiEntryUI(id = "dois")
emailReportUI(id = "send")
```

```{r}
# used to disambiguate excel file names
# TODO replace with shiny session id #83
session_id <- as.character(floor(runif(1) * 1e20))

# get dois
dois <- biblids::doiEntryServer(id = "dois")

dois2 <- reactive({
  with_cr_md <- have_cr_md(dois())
  if (sum(with_cr_md) < 3) {
    shiny::showNotification(
      ui = c(
        "Please provide at least 2 DOIs that can be found on crossref."
      ),
      type = "error"
    )
    return(NULL)
  } else if (any(!with_cr_md)) {
    shiny::showNotification(
      ui = c(
        "Omitted some DOIs for which no metadata on Crossref could be found."
      ),
      type = "warning"
    )
    return(dois()[with_cr_md])
  } else {
    dois()
  }
})

report <- reactive({
  withProgress(
      expr = render_email(dois = dois2(), session_id = session_id),
      message = "Generating report..."
    )
})

# email
emailReportServer(id = "send", dois = dois2, email = report())
```
