---
title: "Metacheck input"
output: 
  flexdashboard::flex_dashboard:
    css: !expr subugoetheme::pkgdown_template()$assets$css
runtime: shiny
---

```{r global, include=FALSE}
library(shiny)
library(shinyvalidate)
library(future)
library(promises)
library(future.callr)
library(metacheck)
html_email <- reactiveVal(value = render_email(dois = unique(tu_dois())))
```


Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}
biblids::doiEntryUI(id = "dois")
actionButton(
  label = "Create Compliance Report",
  inputId = "create",
  width = "100%"
)
textInput(
  inputId = "email",
  label  = "Email Address:",
  placeholder = "jane.doe@uni-foo.edu"
)
actionButton(
  label = "Send Compliance Report",
  inputId = "send",
  width = "100%"
)
```

```{r}
plan(callr)

# used to disambiguate excel file names
session_id <- as.character(floor(runif(1) * 1e20))

# get dois
dois <- biblids::doiEntryServer(id = "dois")

# email
iv <- InputValidator$new()
iv$add_rule("email", sv_required())
iv$add_rule("email", ~ if (!is_valid_email(.)) "Please provide a valid email")
iv$enable()

observeEvent(input$create, {
  myFuture <- future({
    if (length(dois()) > 1) {
     render_email(
       dois = dois(),
       session_id = session_id)$html_html
    }
  })
  then(
    myFuture,
    onFulfilled = function(value) {
      html_email <<- value
    },
    onRejected = NULL
  )
  return(NULL)
})

output$draft <- renderUI(html_email())

observeEvent(input$send, {
  if (length(dois() > 1 & iv$is_valid())) {
    send_email(
      to = input$email,
      email = html_email()
    )
  }
})
```

Results
-----------------------------------------------------------------------

```{r}
shiny::uiOutput("draft")
```
