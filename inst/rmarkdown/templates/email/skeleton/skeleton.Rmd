---
output: blastula::blastula_email
params:
  dois: !r c("10.1007/s10111-020-00626-z", "10.1007/s10444-020-09763-5", "mm")
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(purrr)
library(gt)
library(hybridmdchecker)
```

Hi Michaela,

Thank you for using the HOAD compliance checker. Here's our report.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
cr <- hybridmdchecker::get_cr_md(dois = params$dois)
```

### Indexing status in Crossref

```{r, echo=FALSE}
cr_missing <- !setequal(tolower(params$dois), tolower(cr$doi))
```

```{r not_indexed_in_crossref, eval=cr_missing, echo=FALSE, results = 'asis'}
  glue::glue("
 We found that Crossref indexes **{length(unique(cr$doi))}** out of  **{ length(unique(params$dois))}** articles. **The following DOIS were not registered with Crossref:**
 
 ")
 gluedown::md_bullet(params$dois[!tolower(params$dois) %in% tolower(cr$doi)])
```


```{r, echo=FALSE}
cr_missing <- setequal(tolower(params$dois), tolower(cr$doi))
```

```{r indexed_in_crossref, eval=cr_missing, echo=FALSE, results = 'asis'}
glue::glue("All {length(unique(params$dois))} DOIs have metadata in Crossref")
```

### Compliance overview

```{r, echo=FALSE}
tt <- gather_ind_table(cr)
```


```{r, echo=FALSE}
has_license <- nrow(tt[tt$ind_group == "CC licenses",]) > 0
```

```{r, echo=FALSE, results='asis', eval = 'has_license'}
ind_table_to_gt(tt)
```


```{r, eval=has_license, echo=FALSE}
# check compliance
   compliant_with_license <- hybridmdchecker::license_val(cr)
   # get non-compliant records
   non_compliant_dois <-
     cr$doi[!tolower(cr$doi) %in% tolower(compliant_with_license$doi)]
   # determine why
   out <- if (!is.null(non_compliant_dois))
  purrr::map_df(non_compliant_dois, function(x) {
    cr[cr$doi == x,] %>%
      hybridmdchecker::license_report()
  })
# export
non_compliant <- cr %>%
  select(doi, container.title, publisher, issn) %>%
  filter(doi %in% non_compliant_dois) %>%
  left_join(out, by = "doi") %>%
  mutate(reason = ifelse(is.na(reason), "No license metadata available", reason))

compliant_df <- cr %>%
   license_normalise() %>%
 # select(doi, container.title, publisher, issn) %>%
  inner_join(cr, by = "doi") %>%
   select(doi, container.title, publisher, issn, cc_normalised = license.x)
license_df <- bind_rows(compliant_df, non_compliant) %>%
   mutate(api_link = paste0("https://api.crossref.org/works/", doi)) %>%
   arrange(publisher)
writexl::write_xlsx(license_df, "license_df.xlsx")
```

Please find attached an article-level compliance report. The Excel spreadsheet contains some basic Crossref metadata including Creative Commons license. 

The attached spreadsheet also includes information about articles with a non-compliant open content license. 

**We strongly recommend to report licensing issues to the publisher to ensure that open access articles are discoverable.**

Cheers!

Najko
