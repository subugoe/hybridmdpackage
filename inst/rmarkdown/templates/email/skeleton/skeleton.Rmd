---
output: blastula::blastula_email
params:
  dois: !r c("10.1007/s10111-020-00626-z", "10.1007/s10444-020-09763-5", "mm")
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(purrr)
library(gt)
library(hybridmdchecker)
```

Hi,

Thank you for using the HOAD compliance checker. Here's our report.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
cr <- hybridmdchecker::get_cr_md(dois = params$dois)
```

### Indexing status in Crossref

```{r, echo=FALSE}
cr_missing <- !setequal(tolower(params$dois), tolower(cr$doi))
```

```{r not_indexed_in_crossref, eval=cr_missing, echo=FALSE, results = 'asis'}
  glue::glue("
 We found that Crossref indexes **{length(unique(cr$doi))}** out of  **{ length(unique(params$dois))}** articles. **The following DOIS were not registered with Crossref:**
 
 ")
 gluedown::md_bullet(params$dois[!tolower(params$dois) %in% tolower(cr$doi)])
```


```{r, echo=FALSE}
cr_missing <- setequal(tolower(params$dois), tolower(cr$doi))
```

```{r indexed_in_crossref, eval=cr_missing, echo=FALSE, results = 'asis'}
glue::glue("All DOIs have metadata in Crossref")
```

### Compliance overview

```{r, echo=FALSE}
tt <- gather_ind_table(cr)
ind_table_to_gt(tt)
```


```{r, echo=FALSE}
has_cr <- nrow(cr) > 0
```

```{r, eval=has_cr, echo=FALSE, results="asis"}
# check compliance
   compliant_with_license <- hybridmdchecker::license_val(cr)
   # get non-compliant records
   non_compliant_dois <-
     cr$doi[!tolower(cr$doi) %in% tolower(compliant_with_license$doi)]
   # determine why
   out <- if (!is.null(non_compliant_dois))
     purrr::map_df(non_compliant_dois, function(x) {
       dplyr::filter(cr, doi %in% non_compliant_dois) %>%
         hybridmdchecker::license_report()
     })

out_tt <- out %>%
      mutate(link = glue::glue("[{doi}]({paste0('https://api.crossref.org/works/', doi)})"),
             link = glue::glue("{link} *({reason})*")) %>% 
      select(link, reason) 

glue::glue("### CC license issues in Crossref metadata
           
We have found some issues while checking Crossref metadata relative to open content licensing.

{gluedown::md_bullet(out_tt$link)}

")
```


Cheers!

